<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">
    <meta name="author" content="Jakevin 羅旭辰" />
    <meta name="publisher" content="Jakevin 羅旭辰" />
    <meta name="company" content="北科大工工所" />

    <meta name="rating" content="general" />
    <meta name="copyright" content="&copy; Jakevin Lo" />
    <meta name="robots" content="all" />
    <meta name="spiders" content="all" />
    <meta name="webcrawlers" content="all" />
    <meta name="theme-color" content="#0085d5">
    <meta name="abstract" content="量子天樞| CyberFate" />
    <meta name="subject" content="量子天樞| CyberFate" />
    <meta name="description" content="量子天樞| CyberFate" />
    <meta name="keywords" content="北科大, TTI, AI, FLUX, GPT" />
    <meta property="og:site_name" content="Jakevin" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="量子天樞| CyberFate" />
    <meta property="og:url" content="https://jakevin.github.io/" />
    <meta property="og:description" content="量子天樞| CyberFate" />
    <meta property="og:image"
        content="https://api.together.ai/imgproxy/pXOo77HixdTIUEFb39BSE0_szy_9bn6i9y-uP5kFH5g/format:jpg/aHR0cHM6Ly90b2dldGhlci1haS1iZmwtaW1hZ2VzLXByb2QuczMudXMtd2VzdC0yLmFtYXpvbmF3cy5jb20vaW1hZ2VzLzk0OGRjMzBkYmM2MDBmNzRhZWZmMGU0ZmUwMDM1ZjhjNTFjNGRlYTNhNWY5MGFkNzM0NzBlNzQxZDIyOWYwNmQ_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ29udGVudC1TaGEyNTY9VU5TSUdORUQtUEFZTE9BRCZYLUFtei1DcmVkZW50aWFsPUFTSUFZV1pXNEhWQ0FUV1Q3SlJIJTJGMjAyNDEwMDglMkZ1cy13ZXN0LTIlMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMDA4VDE2MDAxOVomWC1BbXotRXhwaXJlcz0zNjAwJlgtQW16LVNlY3VyaXR5LVRva2VuPUlRb0piM0pwWjJsdVgyVmpFUEQlMkYlMkYlMkYlMkYlMkYlMkYlMkYlMkYlMkYlMkZ3RWFDWFZ6TFhkbGMzUXRNaUpHTUVRQ0lEd2dydUNUOVdZOFpSSUFHV2dSRXR4TFZrJTJCdWg4R3ZaUyUyQjVZczNDSUFZdUFpQnUxNWkzeWxmNzFFJTJGb0x6WFAlMkJRWkpaa0RldVhZQWI2QlJCJTJCMSUyRmtSUHczeXFRQlFoSkVBQWFERFU1T0RjeU5qRTJNemM0TUNJTXhBUiUyQlRhWUtPejlyMWxEYkt1MEUwJTJCbUM1UzNtQlY0Q0daeWowJTJGR0hUZ1J1cyUyRkVJYVk0UXh4c2V6dGwyNHBqeVlMZDhJWHZueGdVVVJuYnNFZ0lFaldac3ViZ1lONyUyQnl3TGV0MUJkcCUyQiUyQnNnTmZ3Y1pSOTkzN0NickRTbGVpODB0cDdyb3cwT2hTd2x1QTNIM3BpakFzRElkSzNqaWR2Z2hNWkFYUkolMkYyUndSUHZPaHlseEU2b2toS2IyMGRKekhEUzNRRlRVRG5jZGpNJTJGaWoyZmV1MFN6VDhBd1RZQWNBaFJGaEo3ViUyQnFvMElyZ2ZRRVV6RmNSSEhmVTlzb3hkUjZYQUUxdSUyQndBb3htOUVJNllqT2NNckVPNzFjSHRjd0IwV3FnJTJGNThlbnoyOEZMdlUlMkZYY3RSS2F6dm9zUHNMcGdHamJLeXc3b3hTJTJGSFAlMkZFb2haVTBzZUhGZVBRdXlKcTg5dHNHQnU5RmJpNUVyekg4amxHNGtMMmQ3RTJwNFFETm11RHNiR2tmTGRLY1EyZSUyQkUlMkZrR1M3MWNJVjNkU0FNRERmMmpPcUdUcUtVa3dCZVElMkJuNndnaWZ3cGEybnpvak5hcGFRbFhQNThUbkpBQSUyQk83U3QzU0dSYkdQQm1tZFRIJTJGenFRZ2tjTTBDRVNqMzNSTEZLTjJWOU1mTXFxakkzJTJCRGJtYm1SbVBSc0NoY2ZPNnNjaFJiNlJOdiUyQmZIczU2M0ZDZkgzNjNJeVNtNEx3Yk54TlFncENVMGdDeEI0dEFOMmo4ck9xemJSVmMyJTJCVVhqYW10VCUyQnF0SmtBOWxXaTNaUTZRazlXTU9hanJqdnQxSmhnY2VrQlN0TXklMkZUaGd5QjhaWUEyclBpczdKRk41ZVY1JTJCOUo4TmdGNGh3Z044U05jSTZtJTJGQXNhb1dvSUNPV1NSb1NsRHViQ0Z5UVVvSFlHMUwlMkJGNEpxczlKS1RrOE9JRDUlMkJlNDFSeDQ2TW9HY1k5ZHBwVmVUNVhtdkdlS2xoNGhKNG5LS0xzN3R0bGJFZFVnYjMlMkJMVGkzdmNEdXNRSmE5ZUxDJTJCczQlMkJNWXc2Tzg3NDZ6NktoSTRnb1hReUQxMHZEejFKYUFsdXdjWDdQJTJGdVBUSEdWd0pnV3hrQ0hhN2w5TUpPdWxiZ0dPcHdCQVhUVGZNRHVITDVtNU5nRVdtTmd4JTJCUmNic1hOcUMzUDFKdWZnOGVJT1lsU1lSVklVZFJLODlzVHJHa3dZU0JzNUJNSnlkalJTQnBJeUxjdnppVk1PWWFGZExiZVAlMkZJZmJZTXRFeno0STh0WnBycUpFeWJScDZ2R21vUTNIWSUyRlBoWlolMkZWR2lMQkY3NGYxV1hUYnBobnp1VjVRTXRkcTMzclNleWhwVHNlYjJwRHhKcSUyRnYwNDQ5T0N2dHo5NTZiMWlCejh5OGtLbDB4M3N3cDcmWC1BbXotU2lnbmF0dXJlPWViZDU4NDU1ODg0OTM0M2ZiNDdjMmMwMDg5MzU0ZjIxYjViYmVmOGY5NDhjOTI3ZjcyMDJjMmE4ODkzMzgxOGUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JngtaWQ9R2V0T2JqZWN0" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@Jakevin16" />
    <meta name="twitter:title" content="量子天樞| CyberFate" />
    <meta name="twitter:url" content="https://jakevin.github.io/" />
    <meta name="twitter:description" content="量子天樞| CyberFate" />
    <meta name="twitter:image:src"
        content="https://api.together.ai/imgproxy/pXOo77HixdTIUEFb39BSE0_szy_9bn6i9y-uP5kFH5g/format:jpg/aHR0cHM6Ly90b2dldGhlci1haS1iZmwtaW1hZ2VzLXByb2QuczMudXMtd2VzdC0yLmFtYXpvbmF3cy5jb20vaW1hZ2VzLzk0OGRjMzBkYmM2MDBmNzRhZWZmMGU0ZmUwMDM1ZjhjNTFjNGRlYTNhNWY5MGFkNzM0NzBlNzQxZDIyOWYwNmQ_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ29udGVudC1TaGEyNTY9VU5TSUdORUQtUEFZTE9BRCZYLUFtei1DcmVkZW50aWFsPUFTSUFZV1pXNEhWQ0FUV1Q3SlJIJTJGMjAyNDEwMDglMkZ1cy13ZXN0LTIlMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMDA4VDE2MDAxOVomWC1BbXotRXhwaXJlcz0zNjAwJlgtQW16LVNlY3VyaXR5LVRva2VuPUlRb0piM0pwWjJsdVgyVmpFUEQlMkYlMkYlMkYlMkYlMkYlMkYlMkYlMkYlMkYlMkZ3RWFDWFZ6TFhkbGMzUXRNaUpHTUVRQ0lEd2dydUNUOVdZOFpSSUFHV2dSRXR4TFZrJTJCdWg4R3ZaUyUyQjVZczNDSUFZdUFpQnUxNWkzeWxmNzFFJTJGb0x6WFAlMkJRWkpaa0RldVhZQWI2QlJCJTJCMSUyRmtSUHczeXFRQlFoSkVBQWFERFU1T0RjeU5qRTJNemM0TUNJTXhBUiUyQlRhWUtPejlyMWxEYkt1MEUwJTJCbUM1UzNtQlY0Q0daeWowJTJGR0hUZ1J1cyUyRkVJYVk0UXh4c2V6dGwyNHBqeVlMZDhJWHZueGdVVVJuYnNFZ0lFaldac3ViZ1lONyUyQnl3TGV0MUJkcCUyQiUyQnNnTmZ3Y1pSOTkzN0NickRTbGVpODB0cDdyb3cwT2hTd2x1QTNIM3BpakFzRElkSzNqaWR2Z2hNWkFYUkolMkYyUndSUHZPaHlseEU2b2toS2IyMGRKekhEUzNRRlRVRG5jZGpNJTJGaWoyZmV1MFN6VDhBd1RZQWNBaFJGaEo3ViUyQnFvMElyZ2ZRRVV6RmNSSEhmVTlzb3hkUjZYQUUxdSUyQndBb3htOUVJNllqT2NNckVPNzFjSHRjd0IwV3FnJTJGNThlbnoyOEZMdlUlMkZYY3RSS2F6dm9zUHNMcGdHamJLeXc3b3hTJTJGSFAlMkZFb2haVTBzZUhGZVBRdXlKcTg5dHNHQnU5RmJpNUVyekg4amxHNGtMMmQ3RTJwNFFETm11RHNiR2tmTGRLY1EyZSUyQkUlMkZrR1M3MWNJVjNkU0FNRERmMmpPcUdUcUtVa3dCZVElMkJuNndnaWZ3cGEybnpvak5hcGFRbFhQNThUbkpBQSUyQk83U3QzU0dSYkdQQm1tZFRIJTJGenFRZ2tjTTBDRVNqMzNSTEZLTjJWOU1mTXFxakkzJTJCRGJtYm1SbVBSc0NoY2ZPNnNjaFJiNlJOdiUyQmZIczU2M0ZDZkgzNjNJeVNtNEx3Yk54TlFncENVMGdDeEI0dEFOMmo4ck9xemJSVmMyJTJCVVhqYW10VCUyQnF0SmtBOWxXaTNaUTZRazlXTU9hanJqdnQxSmhnY2VrQlN0TXklMkZUaGd5QjhaWUEyclBpczdKRk41ZVY1JTJCOUo4TmdGNGh3Z044U05jSTZtJTJGQXNhb1dvSUNPV1NSb1NsRHViQ0Z5UVVvSFlHMUwlMkJGNEpxczlKS1RrOE9JRDUlMkJlNDFSeDQ2TW9HY1k5ZHBwVmVUNVhtdkdlS2xoNGhKNG5LS0xzN3R0bGJFZFVnYjMlMkJMVGkzdmNEdXNRSmE5ZUxDJTJCczQlMkJNWXc2Tzg3NDZ6NktoSTRnb1hReUQxMHZEejFKYUFsdXdjWDdQJTJGdVBUSEdWd0pnV3hrQ0hhN2w5TUpPdWxiZ0dPcHdCQVhUVGZNRHVITDVtNU5nRVdtTmd4JTJCUmNic1hOcUMzUDFKdWZnOGVJT1lsU1lSVklVZFJLODlzVHJHa3dZU0JzNUJNSnlkalJTQnBJeUxjdnppVk1PWWFGZExiZVAlMkZJZmJZTXRFeno0STh0WnBycUpFeWJScDZ2R21vUTNIWSUyRlBoWlolMkZWR2lMQkY3NGYxV1hUYnBobnp1VjVRTXRkcTMzclNleWhwVHNlYjJwRHhKcSUyRnYwNDQ5T0N2dHo5NTZiMWlCejh5OGtLbDB4M3N3cDcmWC1BbXotU2lnbmF0dXJlPWViZDU4NDU1ODg0OTM0M2ZiNDdjMmMwMDg5MzU0ZjIxYjViYmVmOGY5NDhjOTI3ZjcyMDJjMmE4ODkzMzgxOGUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JngtaWQ9R2V0T2JqZWN0" />
    <title>量子天樞</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunisolar-full@2.4.0-4/dist/lunisolar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro/dist/iztro.min.js"></script>
    <script src="config.js"></script>

    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #001f3f;
            color: #ffd700;
        }

        h1 {
            text-align: center;
            color: #ffd700;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background-color: #002f5f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffd700;
        }

        input[type="number"],
        input[type="time"],
        select,
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .date-group {
            display: flex;
            gap: 10px;
        }

        .date-group input {
            width: 33%;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        input[type="radio"] {
            margin: 0;
        }

        #generate-btn {
            width: 100%;
            padding: 12px;
            background-color: #ff4500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        #generate-btn:hover {
            background-color: #ff6347;
        }

        #error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }

        .tab-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: #f0f0f0;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-size: 16px;
        }

        .tab-button.active {
            background-color: #ff4500;
            color: white;
        }

        .tab-content {
            display: none;
            background-color: #002f5f
                /* padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px; */
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            position: relative;
        }

        .form-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .copy-btn {
            padding: 5px 10px;
            background-color: #ff4500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background-color: #ff6347;
        }

        #svgOutput {
            border: 1px solid #ddd;
            padding: 15px;
            line-height: 1.6;
            color: #fff"

        }

        #svgOutput code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }

        #svgOutput pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }

        #svgOutput pre code {
            background-color: transparent;
            padding: 0;
        }

        #svgOutput blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin-left: 0;
            color: #666;
        }

        #svgOutput h1,
        #svgOutput h2,
        #svgOutput h3,
        #svgOutput h4 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        #svgOutput ul,
        #svgOutput ol {
            padding-left: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 31, 63, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-text {
            color: #ffd700;
            font-size: 24px;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .loading-dots {
            animation: dots 1.5s infinite;
            width: 30px;
        }

        .progress-bar {
            width: 80%;
            max-width: 300px;
            height: 10px;
            background-color: rgba(255, 69, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-inner {
            width: 100%;
            height: 100%;
            background-color: #ffd700;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 1s linear;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40%,
            60% {
                content: '..';
            }

            80%,
            100% {
                content: '...';
            }
        }

        a:link {
            color: yellow;
            background-color: transparent;
            text-decoration: none;
        }

        a:visited {
            color: pink;
            background-color: transparent;
            text-decoration: none;
        }

        a:hover {
            color: red;
            background-color: transparent;
            text-decoration: underline;
        }

        a:active {
            color: yellow;
            background-color: transparent;
            text-decoration: underline;
        }

        @keyframes progress {
            0% {
                transform: scaleX(0);
            }

            50% {
                transform: scaleX(1);
            }

            100% {
                transform: scaleX(0);
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay">
        <div class="loading-content">
            <div class="loading-text">
                <div class="loading-message"></div>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-inner"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>量子天樞 Prompt生成器</h1>

        <div class="form-section">
            <label>性別:</label>
            <div class="radio-group">
                <label><input type="radio" name="gender" value="男" required> 男</label>
                <label><input type="radio" name="gender" value="女" required> 女</label>
            </div>

        </div>
        <div class="form-section">
            <label>陽曆出生年月日時分 | 請用+8時區:</label>
            <div class="date-group">
                <input type="datetime-local" id="datetime" style="width: 300px" step="1">
            </div>
            <div id="true-solar-time" style="margin-top: 10px; padding: 10px; background-color: #e8f5e9; border-radius: 4px; display: none; color:red">
                <strong>真太陽時：</strong> <span id="solar-time-result"></span>
            </div>
        </div>
        <div class="form-section">
            <label for="province">出生地:</label>
            <select id="province" required>
                <option value="台灣">台灣</option>
            </select>

            <label for="city">出生城市:</label>
            <select id="city" required>
                <option value="">-- 請選擇 --</option>
            </select>

            <div style="margin-top: 10px;">
                <label for="custom-longitude">自訂經度（選填）:</label>
                <input type="number" id="custom-longitude" step="0.1" min="-180" max="180" placeholder="例如：121.5">
                <div style="color: #ffd700; font-size: 0.9em;">若填寫此欄位將優先使用自訂經度（有效範圍：-180 到 180，東經為正值）</div>
            </div>

            <p style="margin-top: 10px; padding: 10px; background-color: #f5dddd; border-radius: 4px; display: none; color: #000;">
                重要宣告：</br>
                命理學是一種複雜的學問僅供參考，不能作為決策的唯一依據。
            </p>
        </div>

        <checkbox style="display: flex;">
            <label>使用真太陽時：</label>
            <input type="checkbox" id="true-solar-time-checkbox" checked>
        </checkbox>
        <checkbox style="display: flex;">
            <label>加入紫微斗數：</label>
            <input type="checkbox" id="ziwei-checkbox">
        </checkbox>
        <button id="generate-btn">請幫我算一算！</button>
        <div id="error-message"></div>
        <div id="result-layout" class="tab-container" style="display: none;">
            <div class="tab-buttons">
                <button class="tab-button " onclick="switchTab('result')">AI解盤</button>
                <button class="tab-button active" onclick="switchTab('prompt')">Prompt</button>
            </div>
            <div id="result-tab" class="tab-content " style="background-color: #002f5f;color: white;">
                <div id="svgOutput"></div>
            </div>
            <div id="prompt-tab" class="tab-content active" style="background-color: #002f5f">
                <div style="margin-top: 10px; padding: 10px; background-color: #e8f5e9; border-radius: 4px; color: #000;">請把內容複製後，貼給ChatGPT。就能夠無時無刻的與AI老師商談了！
                </div>
                <pre id="output" style="background-color: #002f5f; color:#fff">
                    <button class="copy-btn" onclick="copyPrompt()">複製</button>
                </pre>
            </div>
        </div>
        <div>
            <p>本工具使用 <a href="https://lunisolar.js.org/" style="color: ffd700;" target="_blank">lunisolar</a> 作為天干地支的轉換工具</p>
            <p>本工具使用 <a href="https://iztro.com/" target="_blank">iztro</a> 作為紫微斗數的轉換工具</p>
        </div>
    </div>

    <script>


        document.addEventListener('DOMContentLoaded', function () {
            const datetimeInput = document.getElementById('datetime');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const genderRadios = document.getElementsByName('gender');
            const trueSolarTimeCheckbox = document.getElementById('true-solar-time-checkbox');
            const ziweiCheckbox = document.getElementById('ziwei-checkbox');
            const generateBtn = document.getElementById('generate-btn');
            const errorMessage = document.getElementById('error-message');
            const resultLayout = document.getElementById('result-layout');
            const outputDiv = document.getElementById('output');
            const svgOutput = document.getElementById('svgOutput');



            function populateProvinces() {
                for (const province in locationData) {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                }
            }

            function populateCities(province) {
                citySelect.innerHTML = '<option value="">-- 請選擇 --</option>';
                if (locationData[province]) {
                    for (const city in locationData[province]) {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    }
                }
            }

            // 計算儒略日
            function calculateJulianDate(year, month, day, hour, minute, second) {
                if (month <= 2) {
                    year -= 1;
                    month += 12;
                }
                let a = Math.floor(year / 100);
                let b = 2 - a + Math.floor(a / 4);
                let jd = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) +
                    day + b - 1524.5 + hour / 24 + minute / 1440 + second / 86400;
                return jd;
            }

            // 計算均時差（單位：分鐘）
            function calculateEquationOfTime(jd) {
                // 將儒略日轉換為世紀數
                let T = (jd - 2451545.0) / 36525;

                // 計算太陽平均黃經（度）
                let L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
                L0 = L0 % 360;
                if (L0 < 0) L0 += 360;

                // 計算近日點平均角距（度）
                let M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
                M = M % 360;
                if (M < 0) M += 360;
                let M_rad = M * Math.PI / 180;

                // 計算黃道方程（度）
                let e = 0.016708634 - 0.000042037 * T - 0.0000001267 * T * T;
                let C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M_rad)
                    + (0.019993 - 0.000101 * T) * Math.sin(2 * M_rad)
                    + 0.000289 * Math.sin(3 * M_rad);

                // 計算真黃經（度）
                let L = L0 + C;
                let L_rad = L * Math.PI / 180;

                // 計算黃道傾角（度）
                let eps = 23.43929111 - 0.013004167 * T - 0.000000164 * T * T + 0.000000503 * T * T * T;
                let eps_rad = eps * Math.PI / 180;

                // 計算赤經（弧度）
                let RA = Math.atan2(Math.cos(eps_rad) * Math.sin(L_rad), Math.cos(L_rad));
                if (RA < 0) RA += 2 * Math.PI;

                // 計算均時差（分鐘）
                let eot = (L0 / 15 - RA * 12 / Math.PI) * 60;

                // 修正極端值，確保結果在合理範圍內
                if (eot > 20) eot -= 24 * 60;
                if (eot < -20) eot += 24 * 60;

                return eot;
            }

            // 計算真太陽時
            function calculateTrueSolarTime(dateTime, longitude) {
                // 北京時區（UTC+8）
                const TIMEZONE = 8;

                let year = dateTime.getFullYear();
                let month = dateTime.getMonth() + 1;
                let day = dateTime.getDate();
                let hour = dateTime.getHours();
                let minute = dateTime.getMinutes();
                let second = dateTime.getSeconds();

                // 計算儒略日
                let jd = calculateJulianDate(year, month, day, hour, minute, second);

                // 計算均時差（分鐘）
                let eot = calculateEquationOfTime(jd);

                // 計算經度修正（分鐘）
                let longitudeCorrection = (longitude - TIMEZONE * 15) * 4;

                // 計算真太陽時（分鐘）
                let totalMinutes = hour * 60 + minute + second / 60 + eot + longitudeCorrection;

                // 轉換為時分秒
                let trueSolarHours = Math.floor(totalMinutes / 60) % 24;
                let trueSolarMinutes = Math.floor(totalMinutes % 60);
                let trueSolarSeconds = Math.floor((totalMinutes * 60) % 60);

                // 處理日期變更
                let trueSolarDate = new Date(dateTime);
                if (trueSolarHours < 0) {
                    trueSolarHours += 24;
                    trueSolarDate.setDate(trueSolarDate.getDate() - 1);
                } else if (trueSolarHours >= 24) {
                    trueSolarHours -= 24;
                    trueSolarDate.setDate(trueSolarDate.getDate() + 1);
                }

                // 格式化日期和時間
                const trueSolarYear = trueSolarDate.getFullYear();
                const trueSolarMonth = (trueSolarDate.getMonth() + 1).toString().padStart(2, '0');
                const trueSolarDay = trueSolarDate.getDate().toString().padStart(2, '0');

                return {
                    year: trueSolarYear,
                    month: trueSolarMonth,
                    day: trueSolarDay,
                    hours: trueSolarHours,
                    minutes: trueSolarMinutes,
                    timeString: `${trueSolarYear}/${trueSolarMonth}/${trueSolarDay} ${String(trueSolarHours).padStart(2, '0')}:${String(trueSolarMinutes).padStart(2, '0')}:${String(trueSolarSeconds).padStart(2, '0')}`
                }
            }

            function updateTrueSolarTime() {
                const dateTime = new Date(datetimeInput.value);

                const birthProvince = provinceSelect.value;
                const birthCity = citySelect.value;
                const customLongitude = document.getElementById('custom-longitude').value;
                const longitude = customLongitude ? parseFloat(customLongitude) : locationData[birthProvince][birthCity].longitude;

                const trueSolarTime = calculateTrueSolarTime(dateTime, longitude);
                document.getElementById('solar-time-result').textContent = trueSolarTime.timeString;
                document.getElementById('true-solar-time').style.display = 'block';

                return trueSolarTime;
            }

            function initializeSelectors() {
                const now = new Date('2000-01-25T13:44:00+08:00');
                // const now = new Date('1984-05-25T13:44:00');

                // 格式化當前時間為datetime-local接受的格式 (YYYY-MM-DDThh:mm:ss)
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                datetimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
            }

            function validateForm() {
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
                let isValid = true;

                if (!Array.from(genderRadios).some(radio => radio.checked)) {
                    errorMessage.textContent += "請選擇性別。";
                    isValid = false;
                }

                if (!isValid) {
                    errorMessage.style.display = 'block';
                }
                return isValid;
            }


            let elements = {
                '金': 0,
                '木': 0,
                '水': 0,
                '火': 0,
                '土': 0
            };


            function calculateDayun(origYear, origMonth, origDay, hour, gender, chineseDate) {
                const year = parseInt(origYear);
                const month = parseInt(origMonth);
                const day = parseInt(origDay);

                // 參數驗證
                if (!chineseDate || gender !== '男' && gender !== '女') {
                    throw new Error('無效的參數');
                }

                // 判斷陽年陰年及順逆方向
                const yearStem = chineseDate[0];
                const isYangYear = ["甲", "丙", "戊", "庚", "壬"].includes(yearStem);
                const direction = ((gender === '男' && isYangYear) ||
                    (gender === '女' && !isYangYear)) ? 1 : -1;


                const solarTerms = [
                    // { month: 1, day: 5, name: "小寒" },
                ];

                const prevTermList = lunisolar.SolarTerm.getYearTermDayList(year - 1) // 取得节气日列表
                const nameList = lunisolar.SolarTerm.getNames() // 取得节气名列表
                const currentTermList = lunisolar.SolarTerm.getYearTermDayList(year) // 取得节气日列表

                const nextTermList = lunisolar.SolarTerm.getYearTermDayList(year + 1) // 取得节气日列表

                for (let i = 0; i < 24; i += 2) {
                    const name = nameList[i] // 节气名
                    const m = i / 2  // 月份
                    const d = prevTermList[i] // 日
                    solarTerms.push({ date: new Date(year - 1, m + 1, d), name });
                }

                for (let i = 0; i < 24; i += 2) {
                    const name = nameList[i] // 节气名
                    const m = i / 2 // 月份
                    const d = currentTermList[i] // 日
                    solarTerms.push({ date: new Date(year, m + 1, d), name });
                }

                for (let i = 0; i < 24; i += 2) {
                    const name = nameList[i] // 节气名
                    const m = i / 2 // 月份
                    const d = nextTermList[i] // 日
                    solarTerms.push({ date: new Date(year + 1, m + 1, d), name });
                }

                // 計算出生時刻
                const birthTime = new Date(year, month - 1, day, hour, 0, 0);
                // 找到出生日期所在的两个节气
                let prevTermDate, nextTermDate;
                for (let i = 0; i < solarTerms.length - 1; i++) {
                    if (solarTerms[i].date <= birthTime && birthTime < solarTerms[i + 1].date) {
                        prevTermDate = solarTerms[i];
                        nextTermDate = solarTerms[i + 1];
                        break;
                    }
                }

                // 計算到節氣的時間差（包括日數和時辰）
                const timeDiff = direction === 1 ?
                    nextTermDate.date.getTime() - birthTime.getTime() :
                    birthTime.getTime() - prevTermDate.date.getTime();


                // 計算天數和時辰（1時辰 = 2小時 = 10天）
                const totalDays = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                console.log('totalDays', totalDays);
                const y = Math.floor(totalDays / 3); // 整岁
                const remainingDays = totalDays % 3;     // 剩余天数
                const m = Math.floor(remainingDays * 4); // 折合月份
                console.log('y', y, 'm', m);
                const startAge = y + m / 12;

                /**
                 * 根据起运年龄和出生日期，计算起运的具体年份和时间
                 * @param {Date} birthday - 出生日期（包含时间）
                 * @param {number} totalAge - 起运年龄（可能带有小数，表示月份）
                 * @returns {Object} 起运年份和具体时间
                 */
                function calculateQiYunYear(birthday, totalAge) {
                    const birthYear = birthday.getFullYear();
                    const birthMonth = birthday.getMonth() + 1; // 注意：月份从0开始
                    const birthDay = birthday.getDate();

                    // 将起运年龄拆分为整岁和小数部分
                    const years = Math.floor(totalAge); // 整岁
                    const months = Math.round((totalAge - years) * 12); // 小数部分转换为月份

                    // 计算起运年份
                    let qiYunYear = birthYear + years;
                    let qiYunMonth = birthMonth + months;

                    // 如果月份超过12，则进位到下一年
                    if (qiYunMonth > 12) {
                        qiYunYear += Math.floor(qiYunMonth / 12);
                        qiYunMonth = qiYunMonth % 12 || 12; // 确保月份在1-12之间
                    }

                    // 构造起运日期
                    const qiYunDate = new Date(qiYunYear, qiYunMonth - 1, birthDay); // 注意：月份从0开始

                    return {
                        year: qiYunYear,
                        month: qiYunMonth,
                        date: qiYunDate,
                    };
                }
                const qiYunYear = calculateQiYunYear(birthTime, startAge);
                console.log('qiYunYear', qiYunYear);
                const startYear = qiYunYear.year;

                // 計算大運
                const dayun = [];
                const monthPillar = [chineseDate[3], chineseDate[4]];
                let stemIndex = stems.indexOf(monthPillar[0]);
                let branchIndex = branches.indexOf(monthPillar[1]);

                if (stemIndex === -1 || branchIndex === -1) {
                    throw new Error('無效的月柱');
                }

                // 計算十個大運
                for (let i = 0; i < 10; i++) {
                    stemIndex = ((stemIndex + direction) % 10 + 10) % 10;
                    branchIndex = ((branchIndex + direction) % 12 + 12) % 12;
                    const pillar = stems[stemIndex] + branches[branchIndex];
                    const periodStartYear = startYear + (i * 10);

                    dayun.push({
                        pillar,
                        period: `${pillar} (${periodStartYear}-${periodStartYear + 9}年)`
                    });
                }

                return {
                    startYear,
                    dayun
                };
            }


            function generateBaziPrompt(year, month, day, hours, minutes, gender, includeZiwei) {
                console.log(year, month, day, hours, minutes)
                const lun = lunisolar(`${year}/${month}/${day} ${hours}:${minutes}`)
                console.log(lun)

                const char8ex = lunisolar(`${year}/${month}/${day} ${hours}:${minutes}`).char8ex(gender ? 1 : 0)
                const bigLuck = calculateDayun(year, month, day, hours, gender ? '男' : "女", `${char8ex.char8}`);

                const astrolabe = iztro.astro.bySolar(`${year}/${month}/${day}`, lun.lunar.hour, gender ? '男' : "女", true, 'zh-TW');

                const wuxing = char8ex.char8.year.stem.e5.name + char8ex.char8.year.branch.e5.name + char8ex.char8.month.stem.e5.name + char8ex.char8.month.branch.e5.name + char8ex.char8.day.stem.e5.name + char8ex.char8.day.branch.e5.name + char8ex.char8.hour.stem.e5.name + char8ex.char8.hour.branch.e5.name;

                elements = {
                    '金': 0,
                    '木': 0,
                    '水': 0,
                    '火': 0,
                    '土': 0
                };

                for (let char of wuxing) {
                    if (char in elements) {
                        elements[char]++;
                    }
                }

                let ziwei = ''
                if (includeZiwei) {

                    for (let palace of astrolabe.palaces) {
                        ziwei += `宮位：${palace.heavenlyStem + palace.earthlyBranch} ${palace.name}，主星：`
                        if (palace.majorStars.length === 0) {
                            ziwei += '無 ';
                        } else {
                            for (let star of palace.majorStars) {
                                ziwei += `${star.name}(${star.brightness}) `;
                            }
                        }


                        ziwei += `，副星：`
                        if (palace.minorStars.length === 0) {
                            ziwei += '無 ';
                        } else {
                            for (let star of palace.minorStars) {
                                ziwei += `${star.name}(${star.brightness}) `;
                            }
                        }
                        ziwei += '\n';

                    }
                    ziwei = ziwei.replaceAll('()', '')
                }

                const ziweiPrompt = includeZiwei ? `與紫微斗數命盤` : '';

                let prompt = "";
                prompt += `你是一位對中國傳統八字命理學${ziweiPrompt}有著深刻理解和豐富經驗的專家。你精通《滴天髓》、《子平真詮》、《窮通寶鑒》等經典著作，擅長運用五行生克、十神意象、格局喜忌${ziweiPrompt}等理論，對人生命運進行分析和解讀。\n\n`;
                prompt += `現在你將面對一個八字命例${ziweiPrompt}，請你運用你的專業知識和經驗，對該命盤進行全面、深入的分析，並給出有價值的建議。請你務必逐步思考、推理，並清晰地展示你的思考過程。\n\n`;
                prompt += `- 確保準確性，使用正確的信息進行回應用戶的問題，切勿使用虛假的生日或其他信息。\n`;
                prompt += `### 基礎八字命理規則\n`;
                prompt += `- 五行生克：生 (土生金，金生水，水生木，木生火，火生土). 克 (土克水，水克火，火克金，金克木，木克土)\n`;
                prompt += `- 天干生克關系：\n`;
                prompt += `-- 生 甲木/乙木生丙火/丁火，丙火/丁火生戊土/己土，戊土/己土生庚金/辛金，庚金/辛金生壬水/癸水，壬水/癸水生甲木/乙木。\n`;
                prompt += `-- 克 甲木/乙木克戊土/己土，丙火/丁火克庚金/辛金，戊土/己土克壬水/癸水，庚金/辛金克甲木/乙木，壬水/癸水克丙火/丁火。\n`;
                prompt += `- 十神簡稱/別稱：\n`;
                prompt += `正官：官、七殺：殺，偏官、正印：印、偏印：梟、比肩：比、劫財：劫、食神：食、傷官：傷。正財：財、偏財：才\n`;
                prompt += `- 十神生克: 生 印生比劫， 比劫生食傷，食傷生財，財生官殺，官殺生印。 克 印克食傷，食傷克官殺，財克（破）印，官殺克比劫，比劫克（奪）財。\n`;
                prompt += `- 透出指的是天干有某個五行或十神，如果地支有某個五行或十神，一般叫藏或得地\n`;
                prompt += `- 用神：定格局的十神。比如正官格，用神就為正官。\n`;
                prompt += `- 相神：原局中和用神搭配形成細分格局的十神，輔佐用神提升格局檔次。比如”殺印相生“，用神是七殺，相神就是印（正印或偏印）。\n`;
                prompt += `- 喜神（喜用神）：八字格局喜歡的十神，可以輔助相神或用神提升命運檔次，同時可以克制傷害格局或命運的忌神。\n`;
                prompt += `- 忌神（忌用神）：八字格局忌諱的十神，容易破壞（克或沖）用神或相神\n\n`;

                let requestPrompt = '';
                requestPrompt += `### 求測者的基本資訊如下：\n`;
                requestPrompt += `性别：${gender}\n`;
                requestPrompt += `出生年份：${year}年\n`;
                requestPrompt += `生肖：${zodiac[char8ex.char8.year.branch.value]}\n`;
                requestPrompt += `星座：${astrolabe.sign}\n\n`;

                requestPrompt += `### 其八字命盤如下：\n`;
                requestPrompt += `年柱：${char8ex.char8.year.toString()}(${char8ex.year.stemTenGod.name}) 柱納音：${char8ex.year.takeSound} 五行：${char8ex.char8.year.stem.e5.name + char8ex.char8.year.branch.e5.name}\n`;
                requestPrompt += `月柱：${char8ex.char8.month.toString()}(${char8ex.month.stemTenGod.name}) 柱納音：${char8ex.month.takeSound} 五行：${char8ex.char8.month.stem.e5.name + char8ex.char8.month.branch.e5.name}\n`;
                requestPrompt += `日柱：${char8ex.char8.day.toString()}(${char8ex.day.stemTenGod.name}) 柱納音：${char8ex.day.takeSound} 五行：${char8ex.char8.day.stem.e5.name + char8ex.char8.day.branch.e5.name}\n`;
                requestPrompt += `時柱：${char8ex.char8.hour.toString()}(${char8ex.hour.stemTenGod.name}) 柱納音：${char8ex.hour.takeSound} 五行：${char8ex.char8.hour.stem.e5.name + char8ex.char8.hour.branch.e5.name}\n`;
                requestPrompt += `五行：金(${elements['金']})、木(${elements['木']})、水(${elements['水']})、火(${elements['火']})、土(${elements['土']})\n\n`;

                requestPrompt += `### 大運信息：\n從${bigLuck.startYear}年起運，運程順序為：\n`;
                bigLuck.dayun.forEach(dayun => {
                    requestPrompt += `${dayun.period}\n`;
                });
                requestPrompt += '\n';

                if (includeZiwei) {
                    requestPrompt += `### 其紫微斗數命盤如下：\n`;
                    requestPrompt += `${ziwei}\n\n`;
                }

                requestPrompt += `### 你的分析任務：\n`;
                requestPrompt += `請你從以下幾個方面入手，展開你的分析：\n`;

                requestPrompt += `1.整體審視命局：首先，請你對整個八字命例${ziweiPrompt}進行審視，從五行、陰陽、十神、格局等多個角度入手，對命局的整體特點進行概括性的描述。例如，五行是否均衡？陰陽是否協調？是否存在某種特殊的格局？日元得令、得地、得助嗎？\n\n`;

                requestPrompt += `2.分析日元強弱：日元代表命主自身，其強弱直接關系到命主的運勢。請你結合月令、地支、天干等因素，綜合判斷日元的強弱，並說明判斷的依據。如果日元偏強，喜什麽？忌什麽？如果日元偏弱，又該如何取用神？\n\n`;

                requestPrompt += `3.剖析性格特征：性格決定命運。請你結合八字命例${ziweiPrompt}，分析命主的性格特點、優缺點，以及可能的發展方向。例如，是積極進取還是保守穩重？是善於交際還是喜歡獨處？是理性思維還是感性思維？這些性格特點對命主的人生有何影響？\n\n`;

                requestPrompt += `4.推斷事業發展：事業是人生價值的重要體現。請你結合八字命例${ziweiPrompt}，分析命主的事業運勢、適合的職業、發展方向等。例如，適合從事穩定的工作還是具有挑戰性的工作？適合自己創業還是在企業中發展？在事業發展過程中需要注意哪些問題？\n\n`;

                requestPrompt += `5.預測財富運勢：財富是人生幸福的重要保障。請你結合八字命例${ziweiPrompt}，分析命主的財富狀況、財運走勢、理財建議等。例如，是正財運旺盛還是偏財運旺盛？適合從事哪些行業的投資？在理財方面需要注意哪些問題？\n\n`;

                requestPrompt += `6.研判婚姻情感：婚姻是人生重要的組成部分。請你結合八字命例${ziweiPrompt}，分析命主的婚姻運勢、情感狀況、婚戀建議等。例如，是早婚好還是晚婚好？適合找什麽樣的伴侶？在婚姻中需要注意哪些問題？\n\n`;

                requestPrompt += `7.關注健康狀況：健康是幸福人生的基石。請你結合八字命例${ziweiPrompt}，分析命主的健康狀況、可能存在的健康隱患、養生建議等。例如，五行失衡可能導致哪些疾病？需要注意哪些方面的保健？\n\n`;

                requestPrompt += `8.洞察六親關系：六親是與命主關系最為密切的人。請你結合八字命例${ziweiPrompt}，分析命主與父母、配偶、子女等六親的關系，以及六親對命主的影響。例如，與父母的關系如何？配偶對自己有幫助嗎？子女是否孝順？\n\n`;

                requestPrompt += `9.把握大運流年：大運和流年是影響命主運勢的重要因素。請你結合大運和流年，分析命主在不同人生階段的運勢變化，為命主提供人生規劃建議。例如，哪些年份是機遇期？哪些年份是挑戰期？應該如何把握機遇、應對挑戰？\n\n`;

                requestPrompt += `在分析過程中，請你充分發揮你的聰明才智，運用你所掌握的命理學知識，結合實際情況，對命盤進行深入的剖析和解讀，並給出有價值的建議。\n\n`;
                requestPrompt += `請記住，你的目標是幫助求測者更好地了解自己，把握命運，創造幸福的人生。\n\n`;
                requestPrompt += `請開始你的分析吧！`;

                return {
                    prompt,
                    requestPrompt,
                };
            }

            window.copyPrompt = function () {
                const promptText = outputDiv.textContent.replace('複製', '').trim();
                const url = `http://ezchat.aitwg.com/prompt?prompt=${encodeURIComponent(promptText)}`;
                window.open(url, "_blank");  // Opens in a new tab or window
                navigator.clipboard.writeText(promptText)
                    .then(() => {
                        alert('Prompt 複製完成！');
                    })
                    .catch(err => {
                        console.error('複製失敗:', err);
                        alert('複製失敗，請手動複製。');
                    });
            };


            window.copyResult = function () {
                const resultText = svgOutput.textContent.replace('複製', '').trim();
                navigator.clipboard.writeText(resultText)
                    .then(() => {
                        alert('複製完成！');
                    })
                    .catch(err => {
                        console.error('複製失敗:', err);
                        alert('複製失敗，請手動複製。');
                    });
            };

            generateBtn.addEventListener('click', function () {
                if (validateForm()) {
                    resultLayout.style.display = 'block';

                    const gender = document.querySelector('input[name="gender"]:checked').value;
                    const includeZiwei = ziweiCheckbox.checked;
                    let prompt = '';
                    let requestPrompt = '';
                    let baziPromptObj = {};
                    if (trueSolarTimeCheckbox.checked) {
                        const { year, month, day, hours, minutes } = updateTrueSolarTime();
                        console.log(year, month, day, hours, minutes);
                        baziPromptObj = generateBaziPrompt(year, month, day, hours, minutes, gender, includeZiwei);

                    } else {
                        const birthDay = new Date(datetimeInput.value + '+08:00')
                        const year = birthDay.getFullYear();
                        const month = (birthDay.getMonth() + 1).toString().padStart(2, '0');
                        const day = birthDay.getDate().toString().padStart(2, '0');
                        const hours = birthDay.getHours().toString().padStart(2, '0');
                        const minutes = birthDay.getMinutes().toString().padStart(2, '0');
                        console.log(year, month, day, hours, minutes);
                        baziPromptObj = generateBaziPrompt(year, month, day, hours, minutes, gender, includeZiwei)
                    }

                    prompt = baziPromptObj.prompt;
                    requestPrompt = baziPromptObj.requestPrompt;

                    outputDiv.textContent = prompt + requestPrompt;
                    outputDiv.innerHTML = `<button class="copy-btn" onclick="copyPrompt()">複製</button>` + `<br>` + prompt + requestPrompt;

                    // return
                    fetchResult(requestPrompt);
                }
            });

            const apiUrl = "https://open.aitwg.com/v1/chat/completions";
            //const apiUrl = "http://localhost:3000/ai"

            const loadingOverlay = document.querySelector('.loading-overlay');

            async function fetchResult(prompt) {
                const messages = [
                    "調整坐姿...",
                    "點香祈禱...",
                    "冥想靜心...",
                    "翻閱萬年歷...",
                    "計算五行生克...",
                    "分析大運流年...",
                    "推演吉凶福禍...",
                    "生成解盤資訊..."
                ];
                let currentProgress = 0;
                let messageIndex = 0;

                loadingOverlay.style.display = 'flex';
                const progressBar = document.querySelector('.progress-bar-inner');
                const messageElement = document.querySelector('.loading-message');

                // 設置初始消息
                messageElement.textContent = messages[0];

                // 更新進度和消息的函數
                const updateProgress = () => {
                    if (currentProgress < 90) {
                        currentProgress += 90 / messages.length;
                        progressBar.style.transform = `scaleX(${currentProgress / 100})`;
                        progressBar.style.transition = 'transform 1s linear';
                    }
                };

                // 更新消息的函數
                const updateMessage = () => {
                    if (messageIndex < messages.length - 1) {
                        messageIndex++;
                        messageElement.textContent = messages[messageIndex];
                    }
                };

                // 設置定時器，每2秒更新一次消息
                const messageInterval = setInterval(updateMessage, 2000);
                // 設置定時器，每2秒更新一次進度
                const progressInterval = setInterval(updateProgress, 2000);

                const apiBody = {
                    "model": "grok-free",
                    "prompt": prompt,
                    "stream": false
                }
                try {
                    const response = await fetch(`${apiUrl}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-DMGI1TNyC964ULUfF9AdB9BeC93d4719A2A62f8d40XXXXXX',
                        },
                        body: JSON.stringify(apiBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error) {
                        confirm('目前使用人數眾多，請稍後再試。或複製Prompt到ChatGPT中進行分析。');
                    } else {
                        svgOutput.innerHTML = `<button class="copy-btn" onclick="copyResult()">複製</button></br>` + marked.parse(data.msg.trim().replaceAll('鬥數', '斗數'));
                    }

                } catch (error) {
                    console.error('API請求失敗:', error);
                    confirm('目前使用人數眾多，請稍後再試。或複製Prompt到ChatGPT中進行分析。');

                } finally {
                    // 清理定時器
                    await clearInterval(messageInterval);
                    await clearInterval(progressInterval);


                    setTimeout(() => {
                        progressBar.style.transform = 'scaleX(0)';
                        messageElement.textContent = messages[0];

                        // 重置進度條和消息
                        currentProgress = 0;
                        messageIndex = 0;

                        loadingOverlay.style.display = 'none';
                    }, 500);
                }
            }

            initializeSelectors();
            populateProvinces();
            populateCities('台灣');
            provinceSelect.addEventListener('change', function () {
                const selectedProvince = this.value;
                populateCities(selectedProvince);
            });
        });

        function switchTab(tabName) {

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelector(`.tab-button[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

    </script>
    
</body>

</html>
